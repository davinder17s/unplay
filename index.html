<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unplay - beta</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:400,700" rel="stylesheet">
    <link rel="stylesheet" href="layout.css"/>
</head>
<body>
<div class="player-body">
    <div class="player-container">
        <div class="player-ui" style="background-image: url(bg-art.png)">
            <div class="player-information-container">
                <div class="player-information">
                    <div class="player-art">
                        <img src="artist.png" alt=""/>
                    </div>
                    <div class="player-artist-info">
                        <div class="player-song-name info-name" data-default="No media"></div>
                        <div class="player-song-subinfo info-length" data-default="--:-- / --:--"></div>
                        <div class="player-song-subinfo info-sample-rate" data-default=""></div>
                        <div class="player-song-subinfo"></div>
                    </div>
                </div>
                <div class="player-controls-container player-status">
                    <div class="controls">
                        <div class="button-round backward">
                            <i class="fa fa-backward"></i>
                        </div>
                        <div class="button-round play">
                            <i class="fa fa-play"></i>
                        </div>
                        <div class="button-round pause">
                            <i class="fa fa-pause"></i>
                        </div>
                        <div class="button-round forward">
                            <i class="fa fa-forward"></i>
                        </div>
                        <div class="button-round stop">
                            <i class="fa fa-stop"></i>
                        </div>
                    </div>
                    <div class="seek control-slider">
                        <div class="seek-bar control-slider-bar"></div>
                        <div class="seek-control control-slider-control"></div>
                    </div>
                    <div class="volume-icon">
                        <i class="fa fa-volume-up"></i>
                    </div>
                    <div class="volume control-slider">
                        <div class="volume-bar control-slider-bar"></div>
                        <div class="volume-control control-slider-control"></div>
                    </div>
                </div>
            </div>

        </div>
        <div class="player-playlist">
            <div class="player-playlist-search">
                <input type="text" class="search-input" name="search" placeholder="Search..." id="search"/>
            </div>
            <div class="player-playlist-list">
                <div class="player-playlist-list-item">
                    <div class="playlist-item-icon"><i class="fa fa-play"></i></div>
                    <div class="playlist-item-name">Item 001</div>
                    <div class="playlist-item-remove"><i class="fa fa-trash"></i></div>
                </div>
                <div class="player-playlist-list-item active">
                    <div class="playlist-item-icon"><i class="fa fa-play"></i></div>
                    <div class="playlist-item-name">Item 002</div>
                    <div class="playlist-item-remove"><i class="fa fa-trash"></i></div>
                </div>
                <div class="player-playlist-list-item">
                    <div class="playlist-item-icon"><i class="fa fa-play"></i></div>
                    <div class="playlist-item-name">Item 003</div>
                    <div class="playlist-item-remove"><i class="fa fa-trash"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script type="text/javascript" src="dragSlider.js"></script>
<script>
    String.prototype.lpad = function(padString, length) {
        var str = this;
        while (str.length < length)
            str = padString + str;
        return str;
    }
    var unplay = (function(){
        var _o = {
            AudioContext: null, // reference to web audio context
            AudioSource: null, // reference to source
            AudioGain: null, // reference to gain
            AudioDecodeBuffer: null, // decoded buffer
            playlistFiles: [], // contains list of files to be played
            currentFile: null, // current file that is selected to be played
            currentDataSrc: null, // current file converted to a data source, so we can play it
            isPlaying: false,
            tempTimer: null,
            filterTerm: '',
            AudioTimer: 0,
            info: {
                duration: 0,
                playedTime: 0
            },
            elements: {
                playlistContainer: null, // contains playlist's items
                seek: null, // seek bar element
                volume: null, // volume bar element
                playerBody: null, // whole player's body
                playBtn: null,
                pauseBtn: null,
                prevBtn: null,
                nextBtn: null,
                stopBtn: null,
                playerArtistInfoContainer: null
            },
            // Audio context initialization
            initContext: function(){
                // Initialize browser based audio context
                if (typeof AudioContext !== "undefined") {
                    _o.AudioContext = new AudioContext();
                } else if (typeof webkitAudioContext !== "undefined") {
                    _o.AudioContext = new webkitAudioContext();
                } else {
                    throw new Error('AudioContext not supported. :(');
                }
                // create volume control
                _o.AudioGain = _o.AudioContext.createGain();
                _o.AudioGain.connect(_o.AudioContext.destination);
                // create dummy buffer source
                _o.AudioSource = _o.AudioContext.createBufferSource();
                // set playing status to false
                _o.isPlaying = false;
            },
            // Template for filelist
            templatePlaylistItem: function(file){
                var extraClasses = [];
                if(file == _o.currentFile) {
                    extraClasses.push('active');
                }
                var template = '<div class="player-playlist-list-item '+ extraClasses.join(' ') +'">' +
                        '<div class="playlist-item-icon"><i class="fa fa-play"></i></div>' +
                        '<div class="playlist-item-name">'+ file.name +'</div>' +
                        '<div class="playlist-item-remove"><i class="fa fa-trash"></i></div>' +
                    '</div>';
                var element = $(template);
                // action remove file
                element.find('.playlist-item-remove').click(function(e){
                    e.preventDefault();
                    _o.removeFile(file);
                });
                // action play file
                element.find('.playlist-item-icon, .playlist-item-name').click(function(e){
                    e.preventDefault();
                    _o.setCurrentFile(file);
                    _o.refreshPlaylist();
                });

                return element;
            },
            // Refresh playlist items
            refreshPlaylist: function(){
                // empty out the container before adding the list
                _o.elements.playlistContainer.empty();
                _o.playlistFiles.forEach(function(file){
                    var regex = new RegExp(_o.filterTerm, 'gi');
                    if(regex.test(file.name)) {
                        // generate template for list and append to playlist
                        $(_o.templatePlaylistItem(file)).appendTo(_o.elements.playlistContainer);
                    }

                });
                if(_o.playlistFiles.length == 0) {
                    var templateEmpty = '<div class="player-playlist-list-item"><div class="playlist-item-icon"></div><div class="playlist-item-name"><i class="fa fa-arrows"></i> &nbsp; Drag and Drop audio files here</div></div>';
                    $(templateEmpty).appendTo(_o.elements.playlistContainer);
                }
            },
            // Remove file from playlist
            removeFile: function(file){
                var index = _o.playlistFiles.indexOf(file);
                if(index > -1) {
                    // remove from list and refresh list
                    _o.playlistFiles.splice(index, 1);
                    _o.refreshPlaylist();
                }
                // if currently playing item is removed from the playlist, then remove the reference also
                if(_o.currentFile == file) {
                    // set current file references to null
                    _o.setCurrentFile(null);
                }
            },
            // Add file to playlist
            addFile: function(file){
                // only accept audio file types
                if(/^audio\//.test(file.type)) {
                    _o.playlistFiles.push(file);
                } else {
                    console.warn('Invalid file type: [' + file.type + '] ' + file.name);
                }
            },
            // set current file to new file
            setCurrentFile: function(file){
                // stop currently playing file
                _o.stop();
                _o.currentFile = file;

                // if file refrence is empty, remove data src also
                if(file == null || !file) {
                    _o.currentDataSrc = null;
                    _o.AudioDecodeBuffer = null;
                } else{
                    // read the file and set cached buffer to null
                    _o.AudioDecodeBuffer = null;

                    $('.info-name', _o.elements.playerArtistInfoContainer).html('<i class="fa fa-refresh fa-spin"></i> Crafting music, please wait..');
                    var fr = new FileReader();
                    fr.onload = function(f){
                        // set current data source and play
                        _o.currentDataSrc = f.target.result;
                        _o.play();
                    };
                    fr.readAsArrayBuffer(file);
                }
            },
            // creates buffer for playing the file
            createBuffer: function(callback){
                // handler for buffered files
                function bufferHandler(buffer) {
                    _o.info.duration = buffer.duration;

                    // disconnect old source
                    _o.AudioSource.disconnect();

                    // create new buffer source
                    _o.AudioSource = _o.AudioContext.createBufferSource();
                    _o.AudioSource.buffer = buffer; // set buffer

                    // connect to speakers and gain
                    _o.AudioSource.connect(_o.AudioContext.destination);
                    _o.AudioSource.connect(_o.AudioGain);

                    // after init callback
                    if(typeof callback == 'function') {
                        callback()
                    }
                }
                // if cached buffer exists use it.
                if(_o.AudioDecodeBuffer) {
                    bufferHandler(_o.AudioDecodeBuffer);
                } else {
                    // otherwise try to decode and cache it.
                    if(_o.currentDataSrc) {
                        _o.AudioContext.decodeAudioData(_o.currentDataSrc, function(buffer){
                            _o.AudioDecodeBuffer = buffer; // save for cached references
                            bufferHandler(buffer);
                        });
                    }
                }

            },
            // reset information for audio
            resetInfo: function(){
                _o.info.duration = 0;
                _o.info.playedTime = 0;
            },
            // stop playing
            stop: function(){
                _o.pause();
                _o.resetInfo();
                _o.updateSeekUI(0);
                _o.updatePlayerStatus();
            },
            // start playing
            play: function(){
                // cannot play if there is no file selected.
                if(_o.currentFile == null) {
                    _o.stop();
                }

                // on buffer created successfully.
                _o.createBuffer(function(){
                    if(_o.isPlaying == false) {
                        try{
                            // seek parameter
                            var seekableDuration = parseFloat(_o.info.playedTime);
                            // start audio on seek
                            _o.AudioSource.start(_o.AudioContext.currentTime, seekableDuration);
                        } catch(e) {

                        }

                        _o.isPlaying = true;
                        _o.updatePlayerStatus();
                    }
                });
            },
            // pause playing
            pause: function(){
                if(_o.isPlaying == true) {
                    try{
                        _o.AudioSource.stop();
                    } catch (e) {

                    }
                }
                _o.isPlaying = false;
                _o.updatePlayerStatus();
            },
            // set audio seek to a value
            setSeek: function(value){
                // set audio seek value
                clearTimeout(_o.tempTimer);
                _o.tempTimer = setTimeout(function(){
                    _o.pause(); // pause for a moment
                    // set seek values
                    var seekableDuration = value * _o.info.duration;
                    _o.info.playedTime = seekableDuration;
                    // start playing again
                    _o.play();
                    _o.tempTimer = null;
                }, 500);

            },
            // get slider's current seek value
            getSeek: function(){
                return _o.elements.seek.dragSlider().getValue();
            },
            // update ui seek value to given value
            updateSeekUI: function(value){
                _o.elements.seek.dragSlider().setValue(value, false);
            },
            // set audio volume value
            setVolume: function(value){
                // set audio volume value
                // actual gain value is from -1 to 1 so need to be offset to be between 0 and 1
                _o.AudioGain.gain.value = ((value) - 1);
            },
            // get slider's current volume value
            getVolume: function(){
                return _o.elements.volume.dragSlider().getValue();
            },
            // set slider's current volume value
            updateVolumeUI: function(value){
                _o.elements.volume.dragSlider().setValue(value, false)
            },
            // move to next item
            next: function(){
                _o.resetInfo();
                // it has more than 1 items
                if(_o.playlistFiles.length > 1){
                    var currentIndex = _o.playlistFiles.indexOf(_o.currentFile);
                    if(_o.playlistFiles[currentIndex + 1]){
                        // select next file
                        _o.setCurrentFile(_o.playlistFiles[currentIndex + 1]);
                        _o.refreshPlaylist();
                    } else {
                        _o.stop();
                    }
                } else {
                    _o.stop();
                }
            },
            // move to prev item
            prev: function(){
                _o.resetInfo();
                // has more than 1 items
                if(_o.playlistFiles.length > 1){
                    var currentIndex = _o.playlistFiles.indexOf(_o.currentFile);
                    if(currentIndex > 0 && _o.playlistFiles[currentIndex - 1]){
                        // select previous file
                        _o.setCurrentFile(_o.playlistFiles[currentIndex - 1]);
                        _o.refreshPlaylist();
                    } else {
                        _o.stop();
                    }
                } else {
                    _o.stop();
                }
            },
            // update player status
            updatePlayerStatus: function(){
                if(_o.isPlaying == true) {
                    _o.elements.controlsContainer.addClass('status-playing');
                } else {
                    _o.elements.controlsContainer.removeClass('status-playing');
                }

                var infoName = $('.info-name', _o.elements.playerArtistInfoContainer);
                var infoSampleRate = $('.info-sample-rate', _o.elements.playerArtistInfoContainer);
                var infoDuration = $('.info-length', _o.elements.playerArtistInfoContainer);
                if(_o.info.duration > 0) {
                    infoName.html(_o.currentFile.name);
                    infoSampleRate.html(_o.AudioDecodeBuffer.sampleRate + 'Hz');
                } else {
                    infoName.html(infoName.data('default'));
                    infoSampleRate.html(infoSampleRate.data('default'));
                    infoDuration.html(infoDuration.data('default'));
                }
            },
            updateDuration: function(){
                var playedTime = _o.info.playedTime;
                var duration  = _o.info.duration;
                if(playedTime > duration) {
                    playedTime = duration;
                }
                var playtimeInfo =  parseInt(playedTime / 60).toString().lpad('0', 2) + ':' + parseInt((playedTime) % 60).toString().lpad('0', 2) + ' / '  +
                        parseInt(duration / 60).toString().lpad('0', 2) + ':' + parseInt((duration) % 60).toString().lpad('0', 2);
                $('.info-length', _o.elements.playerArtistInfoContainer).html(playtimeInfo);
            },
            // user interface initialization
            initUI: function(){
                //-- player seek control
                _o.elements.seek.dragSlider();
                _o.elements.seek.on('slider.onslide', function(e, slider){
                    _o.setSeek(slider.getValue());
                });
                //-- /player seek control

                //-- player volume control
                _o.elements.volume.dragSlider();
                _o.elements.volume.on('slider.onslide', function(e, slider){
                    _o.setVolume(slider.getValue());
                });
                _o.setVolume(1.0);
                _o.updateVolumeUI(1.0);
                //-- player volume control

                //-- player drag and drop handler
                _o.elements.playerBody.on('dragover', function(e){
                    e.preventDefault();
                });
                _o.elements.playerBody.on('drop', function(e){
                    e.preventDefault();
                    $.each(e.originalEvent.dataTransfer.files, function(i, file){
                        _o.addFile(file);
                    });
                    if(_o.currentFile == null) {
                        _o.setCurrentFile(_o.playlistFiles[0]);
                    }
                    _o.refreshPlaylist();
                });
                //-- /player drag and drop handler

                //-- player controls handlers
                _o.elements.playBtn.click(function(){
                    _o.play();
                });
                _o.elements.pauseBtn.click(function(){
                    _o.pause();
                });
                _o.elements.stopBtn.click(function(){
                    _o.stop();
                });
                _o.elements.prevBtn.click(function(){
                    _o.prev();
                });
                _o.elements.nextBtn.click(function(){
                    _o.next();
                });
                //-- /player controls handlers

                //-- search bar action
                $('#search').keyup(function(e){
                    e.preventDefault();
                    _o.filterTerm = $(this).val();
                    _o.refreshPlaylist();

                });
                //-- /end search bar action

                //-- watcher for seek
                _o.AudioTimer = Date.now();
                var IntervalWatcher = setInterval(function(){
                    if(_o.isPlaying == true) {
                        if(_o.tempTimer){
                            return;
                        }
                        if(_o.info.duration != 0 && _o.info.playedTime <= _o.info.duration + 1){
                            var percent = (_o.info.playedTime / _o.info.duration);
                            if(percent > 1) {
                                percent = 1;
                            }
                            _o.updateSeekUI(percent);
                            _o.updateDuration();
                            _o.info.playedTime += (Date.now() - _o.AudioTimer) / 1000;
                        } else {
                            _o.next();
                        }
                    }
                    _o.AudioTimer = Date.now();
                }, 300);
            },
            // initialize references to elements
            setReferences: function(){
                _o.elements.playlistContainer = $('.player-playlist-list');
                _o.elements.seek = $('.seek');
                _o.elements.volume = $('.volume');
                _o.elements.playerBody = $('.player-body');
                _o.elements.controlsContainer = $('.player-controls-container');
                _o.elements.playBtn = $('.play', _o.elements.controlsContainer);
                _o.elements.pauseBtn = $('.pause', _o.elements.controlsContainer);
                _o.elements.prevBtn = $('.backward', _o.elements.controlsContainer);
                _o.elements.nextBtn = $('.forward', _o.elements.controlsContainer);
                _o.elements.stopBtn = $('.stop', _o.elements.controlsContainer);
                _o.elements.playerArtistInfoContainer = $('.player-artist-info');
            },
            // initialize all player components
            init: function(){
                // Initialize context and interface
                _o.initContext();
                _o.setReferences();
                _o.initUI();
                _o.refreshPlaylist();
                _o.updatePlayerStatus();
            }
        };
        return _o;
    })();

    $(function(){
        unplay.init();
    });
</script>

</body>
</html>